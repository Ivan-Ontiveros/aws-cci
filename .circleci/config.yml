version: 2.1

orbs:
  node: circleci/node@5.1.0
  aws-cli: circleci/aws-cli@3.1.0

jobs:
  build:
    docker:
      - image: cimg/node:20.5.0
    working_directory: .
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Print Working Directory
          command: pwd
      - run:
          name: Build ViteJS App
          command: npm run build
      - run:
          name: Generate buildCommitSHA.txt
          command: echo $CIRCLE_SHA1 > dist/buildCommitSHA.txt
      - persist_to_workspace:
          root: .
          paths:
            - dist

  deploy:
    docker:
      - image: ubuntu:20.04
    working_directory: .
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Install AWS CLI setup dependencies
          command: |
            apt-get update && apt-get install -y curl unzip
      - aws-cli/setup:
          profile-name: default
      - run:
          name: Print Working Directory
          command: pwd
      - run:
          name: Look in Directory
          command: ls -ltr
      - run:
          name: Backup Current Live to Backup Folder
          command: |
            # Empty the backup folder
            aws s3 rm s3://iodev-aws-cci-poc/backup/ --recursive

            # Move the current live content to the backup folder
            aws s3 mv s3://iodev-aws-cci-poc/live/ s3://iodev-aws-cci-poc/backup/ --recursive
      - run:
          name: Clean Up Live Directory
          command: |
            # Clear the live folder
            aws s3 rm s3://iodev-aws-cci-poc/live/ --recursive
      - run:
          name: Deploy New Build to Live
          command: |
            # Copy the new build files from the dist folder to the live folder
            aws s3 cp --recursive dist/ s3://iodev-aws-cci-poc/live/
      - run:
          name: Invalidate CloudFront Cache
          command: |
            aws cloudfront create-invalidation \
              --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
              --paths "/*"

  rollback:
    docker:
      - image: ubuntu:20.04
    steps:
      - run:
          name: Install AWS CLI setup dependencies
          command: |
            apt-get update && apt-get install -y curl unzip
      - aws-cli/setup:
          profile-name: default
      - run:
          name: Print Working Directory
          command: pwd
      - run:
          name: Look in Directory
          command: ls -ltr
      - run:
          name: Rollback to Previous Version
          command: |
            # Clear the live folder
            aws s3 rm s3://iodev-aws-cci-poc/live/ --recursive

            # Restore the backup to the live folder
            aws s3 cp --recursive s3://iodev-aws-cci-poc/backup/ s3://iodev-aws-cci-poc/live/

            # Invalidate the CloudFront cache to serve the rolled-back build
            aws cloudfront create-invalidation \
              --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
              --paths "/*"

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build:
          filters:
            branches:
              only: master
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
      - hold_for_rollback:
          type: approval
          requires:
            - deploy
          filters:
            branches:
              only: master
      - rollback:
          requires:
            - hold_for_rollback
          filters:
            branches:
              only: master
